include ../tools.mk

# ignore-cross-compile

# Make sure -Zpacked_bundled_libs is compatible with verbatim.

# We're using the llvm-nm instead of the system nm to ensure it is compatible
# with the LLVM bitcode generated by crablangc.
# Except on Windows where piping/IO redirection under MSYS2 is wonky with llvm-nm.
ifndef IS_WINDOWS
NM = "$(LLVM_BIN_DIR)"/llvm-nm
else
NM = nm
endif

all:
	# Build strange-named dep.
	$(CRABLANGC) native_dep.rs --crate-type=staticlib -o $(TMPDIR)/native_dep.ext

	$(CRABLANGC) crablang_dep.rs --crate-type=rlib -Zpacked_bundled_libs
	$(NM) $(TMPDIR)/libcrablang_dep.rlib | $(CGREP) -e "U.*native_f1"
	$(AR) t $(TMPDIR)/libcrablang_dep.rlib | $(CGREP) "native_dep.ext"

	# Make sure compiler doesn't use files, that it shouldn't know about.
	rm $(TMPDIR)/native_dep.ext

	$(CRABLANGC) main.rs --extern crablang_dep=$(TMPDIR)/libcrablang_dep.rlib -Zpacked_bundled_libs
